#!/bin/sh
# Heavily based on the Slackware 13.0 SlackBuild
# http://www.live555.com
# Packagers Gohanz ( gohanz@infinito.it)
# http://www.slacky.it

# Modified for SlackBuilds.org by Erik Hanson <erik@slackbuilds.org>

# Maintained by Christoph Willing <chris.willing@iinet.net.au>

PRGNAM=live555
VERSION=${VERSION:-2014.08.26}
BUILD=${BUILD:-1}
TAG=${TAG:-_SBo}

SRCNAM=live

if [ -z "$ARCH" ]; then
  case "$( uname -m )" in
    i?86) ARCH=i486 ;;
    arm*) ARCH=arm ;;
       *) ARCH=$( uname -m ) ;;
  esac
fi

CWD=$(pwd)
TMP=${TMP:-/tmp/SBo}
PKG=$TMP/package-$PRGNAM
OUTPUT=${OUTPUT:-/tmp}

case "$ARCH" in
  i?86) LIBDIRSUFFIX="" ;;
  x86_64) LIBDIRSUFFIX="64" ;;
esac

set -eu

rm -rf $PKG
mkdir -p $TMP $PKG $OUTPUT
cd $TMP
tar xvf $CWD/$SRCNAM.$VERSION.tar.gz
cd $SRCNAM
chown -R root:root .
find -L . \
 \( -perm 777 -o -perm 775 -o -perm 750 -o -perm 711 -o -perm 555 \
  -o -perm 511 \) -exec chmod 755 {} \; -o \
 \( -perm 666 -o -perm 664 -o -perm 640 -o -perm 600 -o -perm 444 \
  -o -perm 440 -o -perm 400 \) -exec chmod 644 {} \;

#./genMakefiles linux
case "$ARCH" in
  i?86) ./genMakefiles linux ;;
  x86_64) ./genMakefiles linux-64bit ;;
esac
make

mkdir -p $PKG/usr/bin
mkdir -p $PKG/usr/include
mkdir -p $PKG/usr/lib${LIBDIRSUFFIX}/live/BasicUsageEnvironment
mkdir -p $PKG/usr/lib${LIBDIRSUFFIX}/live/UsageEnvironment
mkdir -p $PKG/usr/lib${LIBDIRSUFFIX}/live/groupsock
mkdir -p $PKG/usr/lib${LIBDIRSUFFIX}/live/liveMedia
mkdir -p $PKG/usr/include/BasicUsageEnvironment
mkdir -p $PKG/usr/include/UsageEnvironment
mkdir -p $PKG/usr/include/groupsock
mkdir -p $PKG/usr/include/liveMedia

find $TMP/$SRCNAM/testProgs/ -perm -755	-exec cp {} /$PKG/usr/bin \;
find $TMP/$SRCNAM/mediaServer/ -perm -755 -exec cp {} /$PKG/usr/bin \;
find $TMP/$SRCNAM/BasicUsageEnvironment/*.a -exec cp {} $PKG/usr/lib${LIBDIRSUFFIX}/live/BasicUsageEnvironment/ \;
(cd $PKG/usr/lib${LIBDIRSUFFIX} && ln -s live/BasicUsageEnvironment/*.a )
cp -a $TMP/$SRCNAM/BasicUsageEnvironment/include/*.h* $PKG/usr/include/BasicUsageEnvironment/

find $TMP/$SRCNAM/UsageEnvironment/*.a -exec cp {} $PKG/usr/lib${LIBDIRSUFFIX}/live/UsageEnvironment/ \;
(cd $PKG/usr/lib${LIBDIRSUFFIX} && ln -s live/UsageEnvironment/*.a )
cp -a $TMP/$SRCNAM/UsageEnvironment/include/*.h* $PKG/usr/include/UsageEnvironment/

find $TMP/$SRCNAM/groupsock/*.a -exec cp {} $PKG/usr/lib${LIBDIRSUFFIX}/live/groupsock/ \;
(cd $PKG/usr/lib${LIBDIRSUFFIX} && ln -s live/groupsock/*.a )
cp -a $TMP/$SRCNAM/groupsock/include/*.h* $PKG/usr/include/groupsock/

find $TMP/$SRCNAM/liveMedia/*.a -exec cp {} $PKG/usr/lib${LIBDIRSUFFIX}/live/liveMedia/ \;
(cd $PKG/usr/lib${LIBDIRSUFFIX} && ln -s live/liveMedia/*.a )
cp -a $TMP/$SRCNAM/liveMedia/include/*.h* $PKG/usr/include/liveMedia/

find $PKG | xargs file | grep "executable" | grep ELF | cut -f 1 -d : | xargs strip --strip-unneeded 2> /dev/null
find $PKG | xargs file | grep "current ar archive" | cut -f 1 -d : | xargs strip -g 2> /dev/null

rm -f $PKG/usr/bin/COPYING # Don't need this.
mkdir -p $PKG/usr/doc/$PRGNAM-$VERSION
cp -a COPYING README $PKG/usr/doc/$PRGNAM-$VERSION
cat $CWD/$PRGNAM.SlackBuild > $PKG/usr/doc/$PRGNAM-$VERSION/$PRGNAM.SlackBuild

mkdir -p $PKG/install
cat $CWD/slack-desc > $PKG/install/slack-desc

cd $PKG
/sbin/makepkg -l y -c n $OUTPUT/$PRGNAM-$VERSION-$ARCH-$BUILD$TAG.${PKGTYPE:-tgz}
